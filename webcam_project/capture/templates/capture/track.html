<!-- templates/capture/track.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Live Face Verification</title>
    <style>
        body {
            background-color: #111;
            color: #f0f0f0;
            font-family: 'Segoe UI', sans-serif;
            text-align: center;
            margin: 0;
            padding: 0;
        }

        h1 {
            margin-top: 20px;
            font-size: 2em;
        }

        video {
            margin-top: 20px;
            border: 4px solid #444;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.4);
        }

        #status {
            margin-top: 20px;
            font-size: 1.5em;
            font-weight: bold;
            transition: color 0.3s ease;
        }

        .verified {
            color: #4caf50;
        }

        .not-verified {
            color: #f44336;
        }

        .checking {
            color: #ff9800;
        }
    </style>
</head>
<body>
    <h1>Live Face Verification</h1>
    <video id="video" width="640" height="480" autoplay></video>
    <canvas id="canvas" width="640" height="480" style="display:none;"></canvas>
    <p id="status" class="checking">Verifying...</p>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const context = canvas.getContext('2d');
        const statusText = document.getElementById('status');

        // Start webcam stream
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
                video.srcObject = stream;
            })
            .catch(error => {
                console.error("Error accessing the webcam:", error);
            });

        // CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Capture and send image to backend
        function captureAndSend() {
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = canvas.toDataURL('image/jpeg');

            statusText.textContent = 'Verifying...';
            statusText.className = 'checking';

            fetch('/check-face/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ image: imageData })
            })
            .then(response => response.json())
            .then(data => {
                statusText.textContent = data.message;
                if (data.message.includes("verified")) {
                    statusText.className = 'verified';
                } else if (data.message.includes("not match") || data.message.includes("No face")) {
                    statusText.className = 'not-verified';
                } else {
                    statusText.className = 'checking';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                statusText.textContent = "Error verifying face.";
                statusText.className = 'not-verified';
            });
        }

        // Run every 1 second
        setInterval(captureAndSend, 1000);
    </script>
</body>
</html>
